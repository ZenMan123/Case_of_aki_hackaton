{% extends 'main/html_template.html' %}
{% load static %}
{% load jinja_filters %}
{% load django_template_maths %}

{% block title %}Страница каталога{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'platforms\css\catalogue_page.css' %}">
<link rel="stylesheet" href="{% static 'platforms\css\price_slider.css' %}"
{% endblock %}

{% block content %}

<div class="cat">
    <h2 class="name-of-page">Каталог</h2>
    <p> страница {{ page_id }}</p>
</div>


<div class="row">
    <div class="col" id="filter">
        <h4>Фильтр</h4>
        <div class="form-points">
            <form method="get" action="{% url catalogue_type page_id=1 %}">
            <input name="__filter_form" type="hidden">
            {% for platform_category_name in platform_categories %}
                <fieldset>
                    {% with platform_categories|key:platform_category_name as platform_category %}
                        <legend>{{ platform_category|key:"ru" }}</legend>
                        {% with platform_category|key:"filters" as platform_filters%}
                            {% for filter in platform_filters %}
                                {% with platform_filters|key:filter|key:0 as filter_ru %}
                                    <div class="points">
                                        {% if filter in filters %}
                                            <input type="checkbox" id="{{ filter }}" name="{{ filter }}" checked>
                                        {% else %}
                                            <input type="checkbox" id="{{ filter }}" name="{{ filter }}">
                                        {% endif %}
                                        <label for="{{ filter }}">
                                            {{ filter_ru }}
                                        </label>
                                    </div>
                                {% endwith %}
                            {% endfor %}
                        {% endwith %}
                    {% endwith %}
                </fieldset>
            {% endfor %}

            <!--  Начало ползунка цен    -->
            <div class="wrapper">
              <header>
                <h4>Цена</h4>
              </header>
              <div class="price-input">
                <div class="field">
                    {% if "min_price" in filters %}
                        <input name="min_price" type="number" class="input-min" value='{{ filters|key:"min_price" }}'>
                    {% else %}
                        <input name="min_price" type="number" class="input-min" value="0">
                    {% endif %}
                </div>
                <div class="separator">-</div>
                <div class="field">
                    {% if "max_price" in filters %}
                        <input name="max_price" type="number" class="input-max" value='{{ filters|key:"max_price" }}'>
                    {% else %}
                        <input name="max_price" type="number" class="input-max" value="1000000">
                    {% endif %}
                </div>
              </div>
              <div class="slider">
                <div class="progress"></div>
              </div>
              <div class="range-input">
                  {% if "min_price" in filters %}
                        <input type="range" class="range-min" min="0" max="1000000" value='{{ filters|key:"min_price" }}' step="100">
                  {% else %}
                        <input type="range" class="range-min" min="0" max="1000000" value="0" step="100">
                  {% endif %}
                  {% if "max_price" in filters %}
                        <input type="range" class="range-max" min="0" max="1000000" value='{{ filters|key:"max_price" }}' step="100">
                  {% else %}
                        <input type="range" class="range-max" min="0" max="1000000" value="1000000" step="100">
                  {% endif %}
              </div>
            </div>
            <script src="{% static 'platforms\js\price_slider.js' %}"></script>
            <!--  Конец ползунка цен    -->
            <br>
            <div class="but-filter">
                <button class="btn apply-a-filter" type="submit">Применить фильтр</button>
            </div>
        </form>
        </div>
        
    </div>

    <div class="col-6 catalog-page">
        <div class="catalog-pages">
            <div class="platform">
                {% for platform in platforms %}
                    {% if forloop.counter|sub:1|flr:15|add:1 == page_id %}
                        {% with platform_categories|key:"platform-type"|key:"filters"|key:platform.categories|key:1 as card_color %}
                            <div class="col card" style="border: solid; border-color: #{{card_color}};">
                                <div class="aspect-ratio-box-catalogue card-img-top">
                                    <img src="{{ platform.platformattachment_set.first.file.url }}" alt="{{ platform.name }}">
                                </div>

                                <div class="card-body">
                                    <h5 class="card-title">{{ platform.name }}</h5>
                                    <h6>Тип: Дизайн</h6>
                                    <div class="top">
                                        <div class="img-platforms">
                                            <img src="{% static 'main\img\star.svg' %}" alt="Рейтинг">
                                        </div>
                                        <p>4,5</p>
                                        <img class="comment" src="{% static 'main\img\comment.svg' %}">
                                        <p>100</p>
                                    </div>
                                    <div class="card-text">
                                        <p>{{ platform.short_description }}</p>
                                    </div>


                                </div>
                                <div class="but-in-card">
                                    <a href="{% url 'show_platform_description' platform_id=platform.id %}" class="btn">Подробнее</a>
                                </div>
                            </div>
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            </div>
            
        </div>
        {% if all_pages|length == 0 %}
            <h3>Страниц не найдено.</h3>
        {% else %}
            <div class="number-of-pages">
                {% if page_id != 1 %}
                    <form method="get" action="{% url catalogue_type page_id=page_id|sub:1 %}">
                        <input name="__filter_form" type="hidden">
                        <button type="submit">Предыдущая</button>
                        {% for filter in filters %}
                            <input type="hidden" name="{{ filter }}" value="{{ filters|key:filter }}">
                        {% endfor %}
                    </form>
                {% endif %}
                {% for page_number in all_pages %}
                    {% if page_number >= page_id|sub:2 and page_number <= page_id|add:2 %}
                        <form method="get" id="open_page{{page_number}}" action="{% url catalogue_type page_id=page_number %}">
                            <input name="__filter_form" type="hidden">
                            {% for filter in filters %}
                                <input type="hidden" name="{{ filter }}" value="{{ filters|key:filter }}">
                            {% endfor %}

                            <button class="num-page" type="submit">
                                <div class="pages" style="display: flex; ">
                                    {% if page_number == all_pages|length or page_number == page_id|add:2 %}
                                        <a href="#" onclick="submitForm{{page_number}}()" style="margin-right: 0;"> {{ page_number }} </a>
                                    {% else %}
                                        <a href="#" onclick="submitForm{{page_number}}()"> {{ page_number }} </a>
                                    {% endif %}
                                </div>
                            </button>
                        </form>
                        <script>
                            function submitForm{{page_number}}() {
                                let form = document.getElementById("open_page{{page_number}}");
                                form.submit();
                            }
                        </script>
                    {% endif %}
                {% endfor %}
                {% if page_id != all_pages|length %}
                    <form method="get" action="{% url catalogue_type page_id=page_id|add:1 %}">
                        <input name="__filter_form" type="hidden">
                        <button type="submit">Следующая</button>
                        {% for filter in filters %}
                        <input type="hidden" name="{{ filter }}" value="{{ filters|key:filter }}">
                        {% endfor %}
                    </form>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
