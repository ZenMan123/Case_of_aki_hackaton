{% extends 'main/html_template.html' %}
{% load static %}
{% load jinja_filters %}
{% block title %} {{ platform.name }} {% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'platforms\css\platform_description.css' %}">
<link rel="stylesheet" href="{% static 'platforms\css\calendar.css' %}">
{% endblock %}

{% block content %}

<div class="main-str">
    <div class="str">
        <div class="mypage">
            <div class="photo">
                <div id="carouselExampleCaptions" class="carousel slide" data-bs-ride="carousel">

                    <div class="carousel-indicators">
                        {% for file in platform.platformattachment_set.all %}
                            {% if forloop.counter0 == 0 %}
                                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="{{ forloop.counter0 }}"
                                        class="active" aria-current="true" aria-label="Slide {{ forloop.counter }}"></button>
                            {% else %}
                                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="{{ forloop.counter0 }}"
                                        aria-current="true" aria-label="Slide {{ forloop.counter }}"></button>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="carousel-inner">
                        {% for file in platform.platformattachment_set.all %}
                            {% if forloop.counter0 == 0 %}
                                <div class="carousel-item active" data-bs-interval="5000">
                                    <div class="aspect-ratio-box-carousel">
                                        <img src="{{ file.file.url }}" class="d-block w-100">
                                    </div>
                                </div>
                            {% else %}
                                <div class="carousel-item" data-bs-interval="8000">
                                    <div class="aspect-ratio-box-carousel">
                                        <img src="{{ file.file.url }}" class="d-block w-100">
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions"
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions"
                            data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                </div>

                <div class="name-company">
                    <p class="p-name">{{ platform.name }}</p>
                    <p class="p-type">{{ platform.categories|split:";"|join:",  "}}</p>
                </div>
            </div>
        </div>

        <div class="cols-info">

            <div class="info">
                <h3>Описание</h3>
                <p style="white-space: pre-wrap">{{ platform.description }}</p>
            </div>

            <div class="tops">
                <h4>Информация о площадке</h4>

                <div class="rating">
                    {% if comments %}
                    <img class="stars" src="{% static 'main\img\star.svg' %}" alt="Рейтинг">
                    <p class="p1"> 4.3</p>
                    <p class="main-p">/5</p>
                    <img class="comment" src="{% static 'main\img\comment.svg' %}">
                    <p class="amount-reviews">{{ comments|length }}</p>
                    {% else %}
                    <img class="stars" src="{% static 'main\img\star-yellow.svg' %}" alt="Рейтинг">
                    <p class="main-p">Отзывов пока нет</p>
                    {% endif %}
                </div>
                <br>

                <p>Адрес:</p>
            </div>
        </div>

        {% for comment in comments %}
            <div>
                <span class="text-white">{{ comment.text }}</span> <br>
                <span class="text-white">{{ comment.rating }}</span> <br>
                <img src="{{ comment.commentattachment_set.first.file.url }}" class="card-img-top">
            </div>
        {% endfor %}
    </div>

    {% for month in months %}
        {% if forloop.counter == 1 %}
        <div id="month_table_{{ forloop.counter }}" class="calendar" style="display: block">
        {% else %}
        <div id="month_table_{{ forloop.counter }}" class="calendar" style="display: none">
        {% endif %}
            <h1>{{ month.month }}</h1>
            <table>
                <thead>
                  <tr>
                    <th scope="col">M</th>
                    <th scope="col">T</th>
                    <th scope="col">W</th>
                    <th scope="col">T</th>
                    <th scope="col">F</th>
                    <th scope="col">S</th>
                    <th scope="col">S</th>
                  </tr>
                </thead>
                <tbody class="weeks">
                    {% for week in month.weeks %}
                            <tr>
                            {% for event in week %}
                                {% if event.time_comparison == "less" %}
                                    <td class="last_month_cell">
                                        <button onclick="timetable_button_click(this)"
                                                event_day = {{ event.day }}
                                                event_month = {{ event.month }}
                                                event_month_text = {{ event.month_text }}
                                                event_status = "old_event"
                                                event_year = {{ event.year }}
                                                disabled
                                                title="На этот слот уже нельзя записаться"
                                                event_price = {{ event.price }}
                                                >{{ event.day }}</button>
                                    </td>
                                {% elif event.is_booked %}
                                    <td class="cell_is_busy">
                                        <button onclick="timetable_button_click(this)"
                                                event_day = {{ event.day }}
                                                event_month = {{ event.month }}
                                                event_month_text = {{ event.month_text }}
                                                event_status = "booked_event"
                                                event_year = {{ event.year }}
                                                disabled
                                                title="Этот слот уже занят"
                                                event_price = {{ event.price }}
                                                >{{ event.day }}</button>
                                    </td>
                                {% elif event.time_comparison == "equal" %}
                                    <td class="today_cell">
                                        <button onclick="timetable_button_click(this)"
                                                event_day = {{ event.day }}
                                                event_month = {{ event.month }}
                                                event_month_text = {{ event.month_text }}
                                                event_year = {{ event.year }}
                                                event_status = "free_event"
                                                event_price = {{ event.price }}
                                                >{{ event.day }}</button>
                                    </td>
                                {% else %}
                                    <td class="future_cell">
                                        <button onclick="timetable_button_click(this)"
                                                event_day = {{ event.day }}
                                                event_month = {{ event.month }}
                                                event_month_text = {{ event.month_text }}
                                                event_year = {{ event.year }}
                                                event_status = "free_event"
                                                event_price = {{ event.price }}
                                                >{{ event.day }}</button>
                                    </td>
                                {% endif %}
                            {% endfor %}
                            </tr>
                    {% endfor %}
                </tbody>
            </table> 
        </div>
    {% endfor %}

    <div class="buttons">
        <button id="button_prev_month" type="button" class="btn btn-danger">Посмотреть предыдущий месяц</button>
        <button id="button_next_month" type="button" class="btn btn-danger">Посмотреть следующий месяц</button>
    </div>

    <div class="action">
        {% if user_fields %}
            {% if user_fields.is_staff %}
                {% if platform.verified %}
                    <form action="{% url 'unverify_platform' platform_id=platform.id %}">
                        <button class="btn send" type="submit">Отправить на рассмотрение</button>
                    </form>
                {% else %}
                    <form action="{% url 'verify_platform' platform_id=platform.id %}">
                        <button class="btn apply" type="submit">Принять площадку</button>
                    </form>
                    <button class="btn delete" type="button" id="delete_platform">Удалить площадку</button>
                {% endif %}
            {% elif user_fields.organizer and user_fields.organizer == platform.organizer %}
                    <button class="btn delete" type="button" id="delete_platform">Удалить площадку</button>
            {% endif %}
        {% endif %}
    </div>
    <div class="form-comments">
        <div class="one-comment">
            <div class="hat-comment">
                <p>Lorem</p>
                <div class="top-stars">
                    <img class="stars" src="{% static 'main\img\star-yellow.svg' %}" alt="Рейтинг">
                    <img class="stars" src="{% static 'main\img\star-yellow.svg' %}" alt="Рейтинг">
                    <img class="stars" src="{% static 'main\img\star-grey.svg' %}" alt="Рейтинг">
                    <img class="stars" src="{% static 'main\img\star-grey.svg' %}" alt="Рейтинг">
                    <img class="stars" src="{% static 'main\img\star-grey.svg' %}" alt="Рейтинг">
                    <p style="margin: 0;">2.0</p>
                </div>
            </div>
            <div class="text-comment">
                <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Consequuntur non repudiandae adipisci, libero nam ut doloribus cum earum corrupti, qui.</p>
            </div>
            
        </div>

    </div>

    <!-- Выпадающая форма -->
    <div class="authorize-window" id="calendar-window">
        <div id="calendar-window-form" class="calendar-window-form">
            <h2>{{ platform.name }}</h2>
            <div class="icons-in-form">
                <div class="date">
                    <img src="{% static 'main\img\calendar.svg' %}">
                    <h5 id="date-paragraph-calendar-window-form"></h5>
                </div>

                <div class="price">
                    <img src="{% static 'main\img\price1.svg' %}">
                    <h5 id="price-paragraph-calendar-window-form"></h5>
                </div>

                <div class="offert">
                    <img src="{% static 'main\img\download1.svg' %}">
                    <form action="{% url 'download_agreement' platform_id=platform.id %}" id="download_agreement_form">
                    </form>
                    <a href="#" id="file-paragraph-calendar-window-form" onclick="downloadAgreement()">Скачать оферту</a>
                    <script>
                        function downloadAgreement() {
                            let form = document.getElementById("download_agreement_form");
                            form.submit();
                        }
                        document.getElementById("file-paragraph-calendar-window-form").addEventListener('click', function (e) {
                            e.preventDefault();
                        })
                    </script>
                </div>
            </div>
            <h4>{{ platform.address|key:"address_text" }}</h4>
            <h4 class="status" id="status-paragraph-calendar-window-form"></h4>
            {% if user_fields.client %}
            <div class="form-book">
                <form id="user-client-register-form" method="post" action="{{ url_path }}">
                <div style="display: none">
                    <input id="__calendar_entry_request" name="__calendar_entry_request">
                    <input id="__platform_id" name="__platform_id" type="number" value={{ platform.id }}>
                    <input id="__day" name="__day" type="number" value={{ platform.id }}>
                    <input id="__month" name="__month" type="number">
                    <input id="__year" name="__year" type="number">
                </div>

                {% csrf_token %}
                <button class="btn book" type="submit">Забронировать</button>
            </form>
            </div>
            {% elif user_fields.organizer %}
            <form method="post">
                <input name="__calendar_entry_request" type="hidden">
                {% csrf_token %}
                <button disabled type="submit">Арендодатель не может бронировать слоты</button>
            </form>
            {% else %}
            <form method="post">
                <input name="__calendar_entry_request" type="hidden">
                {% csrf_token %}
                <button id="login_calendar_registrate_button" type="button">Войти</button>
            </form>
            {% endif %}
        </div>
    </div>

</div>

{% if user_fields and user_fields.is_staff and not platform.verified or user_fields.organizer and user_fields.organizer == platform.organizer %}
    <div class="authorize-window" id="confirm_delete_window">
        <div class="confirmation-window">
            <form action="{% url 'delete_platform' platform_id=platform.id %}">
                <button class="btn delete" type="submit">Подтвердить</button>
            </form>
            <button class="btn btn-secondary" id="cancel_delete_button">Отмена</button>
        </div>
    </div>
{% endif %}
    
<script src="{% static 'platforms\js\platform_description.js' %}"></script>
    
{% endblock %}